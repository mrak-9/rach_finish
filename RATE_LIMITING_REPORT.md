# Отчет по настройке ограничения частоты запросов (Rate Limiting)

## Обзор

Реализована комплексная система ограничения частоты запросов для защиты сайта РАЧ от злоупотреблений, DDoS атак и спама. Система включает в себя различные уровни защиты для разных типов операций.

## Реализованные компоненты

### 1. API Rate Limiting

**Файл:** `routes/api.php`

Созданы API маршруты с различными уровнями ограничений:

- **Публичные API (60 запросов/минуту):**
  - GET `/api/events` - список мероприятий
  - GET `/api/events/{event}` - конкретное мероприятие
  - GET `/api/news` - список новостей
  - GET `/api/branches` - список отделений
  - GET `/api/publications` - список публикаций
  - GET `/api/conferences` - список конференций

- **Операции записи (10 запросов/минуту):**
  - POST `/api/conferences/{conference}/register` - регистрация на конференцию
  - POST `/api/membership/payment` - оплата членства
  - POST `/api/membership/qr` - генерация QR кода

- **Чувствительные операции (5 запросов/минуту):**
  - POST `/api/publications/{publication}/upload` - загрузка файлов
  - POST `/api/events` - создание мероприятий (только авторизованные)
  - PUT `/api/events/{event}` - обновление мероприятий
  - DELETE `/api/events/{event}` - удаление мероприятий

- **Авторизованные пользователи (30 запросов/минуту):**
  - GET `/api/user` - информация о пользователе
  - GET `/api/cabinet/*` - пользовательский кабинет

- **Административные операции (3 запроса/минуту):**
  - POST `/api/admin/events` - создание мероприятий администратором
  - PUT `/api/admin/events/{event}` - обновление администратором
  - DELETE `/api/admin/events/{event}` - удаление администратором

### 2. Web Rate Limiting

**Файлы:** `routes/web.php`, `routes/auth.php`

Применены ограничения к веб-интерфейсу:

- **Регистрация на мероприятия:** 10 регистраций/час по IP, 5 регистраций/час по пользователю
- **Платежные операции:** 20 запросов/минуту
- **Загрузка файлов:** 5 загрузок/10 минут
- **Обновление профиля:** 20 запросов/минуту
- **Смена пароля:** 3 запроса/час
- **Авторизация:** 5 попыток/минуту по email, 10 попыток/минуту по IP
- **Восстановление пароля:** 3 запроса/час
- **Регистрация:** 20 регистраций/минуту
- **Отправка email:** 5 писем/час

### 3. Кастомные Rate Limiters

**Файл:** `app/Providers/RateLimitServiceProvider.php`

Создан сервис-провайдер с 12 различными лимитерами:

1. `api` - базовый API лимит (60/мин)
2. `api-write` - операции записи (10/мин)
3. `api-sensitive` - чувствительные операции (5/мин)
4. `api-auth` - авторизованные пользователи (30/мин)
5. `api-admin` - административные операции (3/мин)
6. `web-forms` - веб-формы (20/мин)
7. `file-upload` - загрузка файлов (5/10мин)
8. `search` - поиск (100/мин)
9. `event-registration` - регистрация на мероприятия (10/час по IP, 5/час по пользователю)
10. `email-sending` - отправка email (5/час)
11. `login` - авторизация (5/мин по email, 10/мин по IP)
12. `password-reset` - восстановление пароля (3/час)

### 4. DDoS Protection

**Файл:** `app/Http/Middleware/DDoSProtection.php`

Реализована защита от DDoS атак с проверкой:

- **Частота запросов:** блокировка при >200 запросов/минуту
- **User-Agent:** блокировка подозрительных ботов
- **Одинаковые запросы:** блокировка при >50 одинаковых запросов/минуту
- **404 ошибки:** блокировка при >20 запросов к несуществующим страницам/час
- **Легитимные боты:** разрешены Googlebot, Bingbot, Yandexbot, FacebookExternalHit

### 5. Конфигурация

**Файл:** `config/rate_limiting.php`

Создан конфигурационный файл с настройками:

- Лимиты для всех типов операций
- Сообщения об ошибках на русском языке
- Настройки DDoS защиты
- Белые и черные списки IP
- Настройки логирования

### 6. API методы в контроллерах

**Файл:** `app/Http/Controllers/EventController.php`

Добавлены API методы:

- `apiIndex()` - список мероприятий
- `apiShow()` - конкретное мероприятие
- `apiStore()` - создание мероприятия
- `apiUpdate()` - обновление мероприятия
- `apiDestroy()` - удаление мероприятия
- `apiAdminStore()`, `apiAdminUpdate()`, `apiAdminDestroy()` - административные методы

### 7. Тестирование

**Файл:** `tests/Feature/RateLimitingTest.php`

Созданы тесты для проверки:

- Базового API rate limiting
- Строгих ограничений для операций записи
- Чувствительных операций
- Веб-форм
- Защиты от брутфорса при авторизации
- Восстановления пароля
- Регистрации на мероприятия
- Заголовков в ответах
- Различных лимитов для авторизованных/неавторизованных пользователей

## Настройка middleware

**Файл:** `bootstrap/app.php`

Подключены middleware:

- `throttleApi()` - базовое API throttling
- `throttleWithRedis()` - использование Redis для лучшей производительности
- `DDoSProtection` - защита от DDoS атак

**Файл:** `bootstrap/providers.php`

Зарегистрирован `RateLimitServiceProvider`.

## Особенности реализации

### 1. Гибкая конфигурация
- Все лимиты настраиваются через конфигурационный файл
- Поддержка переменных окружения
- Возможность отключения отдельных компонентов

### 2. Информативные ответы
- Сообщения об ошибках на русском языке
- Заголовки `Retry-After` с временем ожидания
- JSON ответы для API, редиректы для веб-интерфейса

### 3. Различные стратегии лимитирования
- По IP адресу для анонимных пользователей
- По ID пользователя для авторизованных
- Комбинированные лимиты (по IP + по пользователю)

### 4. Логирование и мониторинг
- Логирование подозрительной активности
- Отслеживание высокой активности пользователей
- Статистика по IP адресам

### 5. Производительность
- Использование Redis для хранения счетчиков
- Оптимизированные алгоритмы проверки
- Минимальное влияние на производительность

## Рекомендации по развертыванию

### 1. Настройка Redis
```bash
# Установка Redis
sudo apt install redis-server

# Настройка Laravel для использования Redis
CACHE_DRIVER=redis
RATE_LIMIT_CACHE_STORE=redis
```

### 2. Переменные окружения
```env
DDOS_PROTECTION_ENABLED=true
RATE_LIMIT_LOGGING=true
RATE_LIMIT_LOG_CHANNEL=daily
```

### 3. Мониторинг
- Настройте мониторинг логов для отслеживания атак
- Используйте метрики для анализа трафика
- Регулярно проверяйте статистику блокировок

### 4. Тонкая настройка
- Адаптируйте лимиты под реальную нагрузку
- Добавляйте доверенные IP в белый список
- Блокируйте известные источники атак

## Безопасность

### Защита от:
- **DDoS атак** - ограничение частоты запросов
- **Брутфорс атак** - лимиты на авторизацию
- **Спама** - ограничения на формы и email
- **Сканирования** - отслеживание 404 ошибок
- **Злоупотреблений API** - различные лимиты для разных операций

### Дополнительные меры:
- Проверка User-Agent
- Отслеживание подозрительных паттернов
- Автоматическая блокировка при превышении лимитов
- Логирование всех инцидентов

## Заключение

Реализована комплексная система ограничения частоты запросов, которая обеспечивает:

1. **Защиту от атак** - DDoS, брутфорс, спам
2. **Гибкость настройки** - различные лимиты для разных операций
3. **Удобство использования** - информативные сообщения об ошибках
4. **Производительность** - оптимизированная работа с Redis
5. **Мониторинг** - подробное логирование и статистика

Система готова к использованию в продакшене и может быть легко адаптирована под конкретные требования проекта.